name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-linux-windows:
    name: Build (Linux & Windows)
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y curl zip tar jq pkg-config libssl-dev

      - name: Install Rust & Cross
        run: |
          curl https://sh.rustup.rs -sSf | sh -s -- -y
          source "$HOME/.cargo/env"
          cargo install cross

      - name: Run release.sh
        run: |
          source "$HOME/.cargo/env"
          bash ./release.sh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-linux-windows-dist
          path: dist/*

      - name: Upload binaries to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: Build (macOS)
    runs-on: macos-15
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: brew install zip

      - name: Install Rust
        run: |
          curl https://sh.rustup.rs -sSf | sh -s -- -y
          source "$HOME/.cargo/env"
          rustup target add x86_64-apple-darwin

      - name: Build for macOS
        run: |
          source "$HOME/.cargo/env"
          cargo build --release --target x86_64-apple-darwin

      - name: Compress macOS binaries
        run: |
          set -e

          VERSION=$(grep '^version' Cargo.toml | head -n1 | sed -E 's/version *= *"([^"]+)"/\1/')
          NAME=uwais-v${VERSION}-x86_64-macos

          mkdir -p dist
          cp target/x86_64-apple-darwin/release/uwais dist/${NAME}

          cd dist
          zip ${NAME}.zip ${NAME}
          tar -czvf ${NAME}.tar.gz ${NAME}
          rm ${NAME}

      - name: Upload macOS binaries to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  windows-installer:
    name: Windows Installer
    runs-on: windows-2025
    needs: build-linux-windows
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: build-linux-windows-dist
          path: dist/

      - name: Extract version from Cargo.toml
        id: extract_version
        shell: bash
        run: echo UWAIS_VERSION=$(grep '^version' Cargo.toml | head -n1 | cut -d '"' -f2) >> $GITHUB_ENV

      - name: Install Inno Setup
        shell: powershell
        run: |
          Invoke-WebRequest -Uri https://jrsoftware.org/download.php/is.exe -OutFile is.exe
          Start-Process -Wait -FilePath .\is.exe -ArgumentList '/VERYSILENT', '/NORESTART', '/SP-', '/DIR="C:\Program Files (x86)\Inno Setup 6"'

      - name: Add Inno Setup to PATH
        shell: powershell
        run: |
          echo "C:\Program Files (x86)\Inno Setup 6" | Out-File -Append $env:GITHUB_PATH

      - name: Generate installer.iss
        shell: cmd
        run: |
          echo #define MyAppVersion "${{ env.UWAIS_VERSION }}" > installer.iss
          echo [Setup] >> installer.iss
          echo AppName=uwais >> installer.iss
          echo AppVersion={#MyAppVersion} >> installer.iss
          echo DefaultDirName={pf}\uwais >> installer.iss
          echo DefaultGroupName=uwais >> installer.iss
          echo OutputBaseFilename=uwais-v{#MyAppVersion}-installer >> installer.iss
          echo Compression=lzma >> installer.iss
          echo SolidCompression=yes >> installer.iss
          echo [Files] >> installer.iss
          echo Source: "dist\uwais-v{#MyAppVersion}-x86_64-windows.exe"; DestDir: "{app}"; DestName: "uwais.exe"; Flags: ignoreversion >> installer.iss
          echo [Registry] >> installer.iss
          echo Root: HKCU; Subkey: "Environment"; ValueType: expandsz; ValueName: "Path"; ValueData: "{olddata};{app}"; Flags: preservestringtype >> installer.iss
          echo [Run] >> installer.iss
          echo Filename: "powershell.exe"^; Parameters: "-NoProfile -ExecutionPolicy Bypass -Command Set-ItemProperty -Path 'HKCU:\Environment' -Name Path -Value ([System.Environment]::GetEnvironmentVariable('Path','User') + ';{app}')^; Flags: runhidden >> installer.iss
          echo [UninstallRun] >> installer.iss
          echo Filename: "powershell.exe"^; Parameters: "-NoProfile -ExecutionPolicy Bypass -Command $userPath = ([System.Environment]::GetEnvironmentVariable('Path','User') -split ';' ^| Where-Object {{ $_ -ne '{app}' }}); [System.Environment]::SetEnvironmentVariable('Path', ($userPath -join ';'), 'User')"^; Flags: runhidden >> installer.iss
          echo [UninstallDelete] >> installer.iss
          echo Type: dirifempty^; Name: "{app}" >> installer.iss

      - name: Create Windows Installer
        shell: cmd
        run: |
          "C:\Program Files (x86)\Inno Setup 6\iscc.exe" ^
            /DMyAppVersion=${{ env.UWAIS_VERSION }} ^
            /DMyTargetTriple=x86_64-windows ^
            /Odist ^
            /Fuwais-v${{ env.UWAIS_VERSION }}-x86_64-windows-installer ^
            installer.iss

      - name: Upload Windows Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/uwais-v${{ env.UWAIS_VERSION }}-x86_64-windows-installer.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
